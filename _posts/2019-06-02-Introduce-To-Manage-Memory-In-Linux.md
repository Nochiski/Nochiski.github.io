---
layout: posts
title: Introduce to Memory Management in Linux
#category: C/C++
#tags: [C++, C, Memory]
---
### 시작 전
다음과 같은 사전 지식이나 경험이 있다면 더 쉽게 이해할 수 있습니다.
  * C 혹은 C++ 언어
  * 메모리 동작과 구조에 대한 이해

---
### 메모리란?
 메모리란 프로그래밍에서의 변수(variable)와 함수(function) 혹은 메서드(method)를 저장하는 공간입니다. 특히 C에서는 포인터(pointer)와 참조(reference)를 통해 저장된 공간의 주소를 알 수 있습니다. 프로그래머가 프로그램에 시스템 함수를 통해 운영체제(이하 OS)에 메모리를 요청하면, 그 뒤 OS는 할당할 수 있는 메모리를 프로그램에게 허락합니다. 이후 프로그램은 변수를 표준할당자를 통해 할당받은 메모리에 저장합니다.

---

### 유닉스 시스템에서의 동적 할당
 유닉스 시스템의 표준 메모리 할당자는 두 가지 기능을 지원합니다. 첫 번째는 프로그래머의 요청에 따라 메모리를 할당(allocate)하고, 두 번째는 할당된 메모리를 사용하지 않으면 해제(release)해주는 것입니다.

---

### 표준 동적 할당 방법
 다음과 같은 3가지 타입의 동적할당자를 제공합니다.
~~~cpp
void *malloc(size_t size);
~~~
size만큼의 메모리를 힙(heap)에 할당하고, 할당받은 메모리의 첫번째 주소를 반환합니다.

~~~cpp
void *calloc(size_t nmemb, size_t size);
~~~
nmemb * size만큼의 힙에 메모리를 할당하고, 할당된 변수의 값을 0으로 지정합니다.

~~~cpp
void *realloc(void *ptr, size_t size);
~~~
ptr의 크기를 size로 바꾸고 새로운 주소를 반환합니다.

어떠한 동적할당자로 메모리를 할당하던, 해제하는 방법은 단 한가지입니다.
~~~cpp
void free(void *ptr);
~~~
free()를 사용해 힙 영역에 할당된 메모리를 해제합니다.

---
### 자유 리스트(Free List)
 사실 동적 할당자를 사용해 OS로부터 메모리를 할당받을때, 정확하게 요청받은 사이즈만 가져오지 않습니다. <br>

 OS로부터 4096(2<sup>12</sup>)바이트만큼의 메모리를 얻어온 후(구현에 따라 차이가 있을 수 있습니다), 얻어온 메모리를 일정하게 2의 제곱수(2,4,8,32,64 ... )로 나눠 연결리스트(Linked List)를 생성합니다. <br>

 ![freelist](https://drive.google.com/uc?id=1lYC1WB-JrA_S9RoeW72QYuFi6kWGvOog)

 이것을 자유리스트(Free List) 또는 자유체인(Free Chain)이라고 부릅니다. 위의 예시는 64바이트의 블록을 요청할때 4096만큼의 메모리를 얻어온 후,64바이트를 저장하는 메모리블록을 64개 생성한 모습입니다.<br>

 ![freelist2](https://drive.google.com/uc?id=1T_e4Xd6bunHMDwJcLregzRv9D83WISga)
 이 메모리블록들은 메모리가 할당되면 연결리스트에서 삭제(remove)되며, 메모리가 해제된 후에 다시 연결리스트로 편입(append)됩니다. 동적할당자가 호출될 때, 이 자유리스트에 적절하게 남은 공간이 존재하는 한, 새로 메모리를 OS에서 할당받지 않고 연결리스트에서 미리 할당받은 메모리를 얻어옵니다.

 ![freearray](https://drive.google.com/uc?id=11_toSH5thB4_BP4PZUZ6rXuuh6LG_Z8E)

 또한 void*형 배열에 자유리스트 헤더의 주솟값을 저장합니다. 이 배열은 자유리스트의 탐색에 사용됩니다.

---
### 메모리 블록(Free List Block)
 메모리 블록은 자유리스트의 요소(elements)들을 지칭합니다. malloc을 통해 메모리를 요청할때 실제 크기보다 8바이트 더 큰 사이즈를 할당받아야 합니다. 이렇게 할당받은 8바이트는 메모리 블록의 맨 앞에 위치하게 되며, 메모리의 크기를 나타내는 헤더(header)로서 사용됩니다.

 <center><img src="https://drive.google.com/uc?id=1Kim0BPZImN4I6AnDj_eUdLPGlkT1cyuG" width="300" height="300"></center>

 만일 변수의 실제 사이즈가 메모리블록의 사이즈보다 작을시, 나머지는 사용하지않고 비워둡니다. 이것을 패딩(Padding)이라고 합니다.

 35바이트의 메모리를 할당해올때 얻어지는 실제 사이즈는 43바이트입니다. 또한 43바이트는 36(2<sup>5</sup>)보다 크지만 64(2<sup>6</sup>)보다 작으므로, 64만큼의 크기의 블록에 할당됩니다. 따라서 8바이트의 헤더와, 35바이트의 변수 그리고 나머지 21바이트의 패딩이 존재하게 됩니다. 이 블록은 할당과 동시에 자유 리스트에서 삭제되며, 메모리가 해제될 때 다시 자유리스트로 추가됩니다.

---
### 요약
  * 각 동적할당자가 호출될때 자유리스트에 적절한 메모리블록이 존재하지 않으면 OS로부터 한번에 많은 메모리를 얻어옵니다.
  * 이후 메모리를 할당할때 자유리스트에 여분의 메모리 블록이 존재하면 적절한 메모리블록을 사용한 뒤, 자유리스트에서 그 메모리블록을 삭제합니다.
  * 메모리가 해제되면 사용되던 메모리블록은 자유리스트에 다시 편입됩니다.
